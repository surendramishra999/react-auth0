{"ast":null,"code":"import _classCallCheck from \"/mnt/d/projects/react-auth0/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/mnt/d/projects/react-auth0/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport auth0 from 'auth0-js';\nvar REDIRACT_ON_LOGIN = 'redirect_on_login';\nvar ROLE_URL = \"http://localhost:3000/roles\";\nvar _access_token = null;\nvar _roles = null;\nvar _expire_at = null;\nvar _scopes = null;\n\nvar Auth =\n/*#__PURE__*/\nfunction () {\n  function Auth(history) {\n    var _this = this;\n\n    _classCallCheck(this, Auth);\n\n    this.login = function () {\n      _this.auth0.authorize();\n\n      localStorage.setItem(REDIRACT_ON_LOGIN, JSON.stringify(_this.history.location));\n    };\n\n    this.handleAuthentication = function () {\n      _this.auth0.parseHash(function (err, authResult) {\n        if (authResult && authResult.accessToken && authResult.idToken) {\n          _this.setSession(authResult);\n\n          var redirectUrl = localStorage.getItem(REDIRACT_ON_LOGIN) === \"undefined\" ? '/' : JSON.parse(localStorage.getItem(REDIRACT_ON_LOGIN));\n\n          _this.history.push(redirectUrl);\n        } else if (err) {\n          _this.history.push('/');\n\n          alert(\"Error :\".concat(err.error, \". Check console log for more details\"));\n          console.log(err);\n        }\n      });\n    };\n\n    this.setSession = function (authResult) {\n      //set expire time\n      _expire_at = authResult.expiresIn * 1000 + new Date().getTime();\n      _scopes = authResult.scope || _this.requestedScope || '';\n      _access_token = authResult.accessToken;\n      _roles = authResult.idTokenPayload[ROLE_URL];\n\n      _this.scheduleTokenRenewal();\n    };\n\n    this.logout = function () {\n      _access_token = null;\n      _expire_at = null;\n      _scopes = null;\n      _roles = null;\n      localStorage.removeItem(REDIRACT_ON_LOGIN);\n      _this.userProfile = null;\n\n      _this.auth0.logout({\n        clientID: process.env.REACT_APP_AUTH0_CLIENT_ID,\n        returnTo: \"http://localhost:3000/\"\n      });\n\n      _this.history.push('/');\n    };\n\n    this.getAccessToken = function () {\n      if (!_access_token) {\n        throw new Error(\"No Access Token found\");\n      }\n\n      return _access_token;\n    };\n\n    this.getProfile = function (cb) {\n      if (_this.userProfile) return cb(_this.userProfile);\n\n      _this.auth0.client.userInfo(_this.getAccessToken(), function (error, userProfile) {\n        if (userProfile) _this.userProfile = userProfile;\n        cb(userProfile, error);\n      });\n    };\n\n    this.userHasScopes = function (scopes) {\n      var grantedScopes = (_scopes || \"\").split(\" \");\n\n      return scopes.every(function (scope) {\n        return grantedScopes.includes(scope);\n      });\n    };\n\n    this.checkRole = function (role) {\n      var roles = _roles || [];\n      return roles.includes(role);\n    };\n\n    this.history = history;\n    this.requestedScope = \"openid profile email read:courses\";\n    this.auth0 = new auth0.WebAuth({\n      domain: process.env.REACT_APP_AUTH0_DOMAIN,\n      clientID: process.env.REACT_APP_AUTH0_CLIENT_ID,\n      redirectUri: process.env.REACT_APP_AUTH0_CALLBACK_URL,\n      audience: process.env.REACT_APP_AUTH0_AUDIENCE,\n      responseType: \"token id_token\",\n      scope: this.requestedScope\n    });\n  }\n\n  _createClass(Auth, [{\n    key: \"isAuthenticated\",\n    value: function isAuthenticated() {\n      return new Date().getTime() < _expire_at;\n    }\n  }, {\n    key: \"renewToken\",\n    value: function renewToken(cb) {\n      var _this2 = this;\n\n      this.auth0.checkSession({}, function (error, result) {\n        if (error) {\n          console.log(\"error: \".concat(error.error, \" - \").concat(error.errorDescription));\n        } else {\n          _this2.setSession(result);\n        }\n\n        if (cb) cb(error, result);\n      });\n    }\n  }, {\n    key: \"scheduleTokenRenewal\",\n    value: function scheduleTokenRenewal() {\n      var _this3 = this;\n\n      var delay = _expire_at - new Date().getTime();\n\n      if (delay > 0) {\n        setTimeout(function () {\n          _this3.renewToken();\n        }, delay);\n      }\n    }\n  }]);\n\n  return Auth;\n}();\n\nexport { Auth as default };","map":{"version":3,"sources":["/mnt/d/projects/react-auth0/src/Auth/Auth.js"],"names":["auth0","REDIRACT_ON_LOGIN","ROLE_URL","_access_token","_roles","_expire_at","_scopes","Auth","history","login","authorize","localStorage","setItem","JSON","stringify","location","handleAuthentication","parseHash","err","authResult","accessToken","idToken","setSession","redirectUrl","getItem","parse","push","alert","error","console","log","expiresIn","Date","getTime","scope","requestedScope","idTokenPayload","scheduleTokenRenewal","logout","removeItem","userProfile","clientID","process","env","REACT_APP_AUTH0_CLIENT_ID","returnTo","getAccessToken","Error","getProfile","cb","client","userInfo","userHasScopes","scopes","grantedScopes","split","every","includes","checkRole","role","roles","WebAuth","domain","REACT_APP_AUTH0_DOMAIN","redirectUri","REACT_APP_AUTH0_CALLBACK_URL","audience","REACT_APP_AUTH0_AUDIENCE","responseType","checkSession","result","errorDescription","delay","setTimeout","renewToken"],"mappings":"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","sourcesContent":["import auth0 from 'auth0-js';\r\nconst REDIRACT_ON_LOGIN='redirect_on_login';\r\nconst ROLE_URL=\"http://localhost:3000/roles\";\r\n\r\nlet _access_token=null;\r\nlet _roles=null;\r\nlet _expire_at=null;\r\nlet _scopes=null;\r\n\r\nexport default class Auth{\r\n  constructor(history){\r\n   this.history=history;\r\n   this.requestedScope=\"openid profile email read:courses\";\r\n   this.auth0=new auth0.WebAuth({\r\n       domain:process.env.REACT_APP_AUTH0_DOMAIN,\r\n       clientID:process.env.REACT_APP_AUTH0_CLIENT_ID,\r\n       redirectUri:process.env.REACT_APP_AUTH0_CALLBACK_URL,\r\n       audience:process.env.REACT_APP_AUTH0_AUDIENCE,\r\n       responseType:\"token id_token\",\r\n       scope:this.requestedScope\r\n   });\r\n  }\r\n\r\n  login =()=>{\r\n    this.auth0.authorize();\r\n    localStorage.setItem(REDIRACT_ON_LOGIN,JSON.stringify(this.history.location));\r\n  }\r\n\r\n  handleAuthentication=()=>{\r\n    this.auth0.parseHash((err,authResult)=>{\r\n      if(authResult && authResult.accessToken && authResult.idToken){\r\n         this.setSession(authResult);\r\n         const redirectUrl=(localStorage.getItem(REDIRACT_ON_LOGIN)===\"undefined\")\r\n         ?'/':JSON.parse(localStorage.getItem(REDIRACT_ON_LOGIN));\r\n         this.history.push(redirectUrl);\r\n      }else if(err){\r\n        this.history.push('/');\r\n        alert(`Error :${err.error}. Check console log for more details`);\r\n        console.log(err);\r\n      }\r\n    });\r\n  }\r\n\r\n  setSession=authResult=>{\r\n    //set expire time\r\n    _expire_at=(authResult.expiresIn * 1000 + new Date().getTime());\r\n    _scopes=authResult.scope || this.requestedScope || '';\r\n    _access_token=authResult.accessToken;\r\n    _roles=authResult.idTokenPayload[ROLE_URL];\r\n    this.scheduleTokenRenewal();\r\n  }\r\n\r\n  isAuthenticated(){\r\n    return new Date().getTime()<_expire_at;\r\n  }\r\n\r\n  logout=()=>{\r\n    _access_token=null;\r\n    _expire_at=null;\r\n    _scopes=null;\r\n    _roles=null;\r\n    localStorage.removeItem(REDIRACT_ON_LOGIN);\r\n    this.userProfile=null;\r\n    this.auth0.logout({\r\n      clientID:process.env.REACT_APP_AUTH0_CLIENT_ID,\r\n      returnTo:\"http://localhost:3000/\"\r\n    });\r\n    this.history.push('/');\r\n  }\r\n\r\n  getAccessToken=()=>{\r\n    if(!_access_token){\r\n     throw new Error(\"No Access Token found\");\r\n    }\r\n    return _access_token;\r\n  }\r\n\r\n  getProfile=cb=>{\r\n   if(this.userProfile) return cb(this.userProfile);\r\n   this.auth0.client.userInfo(this.getAccessToken(),(error,userProfile)=>{\r\n     if(userProfile) this.userProfile=userProfile;\r\n     cb(userProfile,error);\r\n   });\r\n\r\n  }\r\n\r\n  userHasScopes=(scopes)=>{\r\n   const grantedScopes=(\r\n    _scopes|| \"\"\r\n   ).split(\" \");\r\n   return scopes.every(scope=>grantedScopes.includes(scope));\r\n  }\r\n\r\n  checkRole=(role)=>{\r\n    const roles=(\r\n      _roles|| []\r\n    );\r\n    return roles.includes(role);\r\n   }\r\n\r\n   renewToken(cb){\r\n     this.auth0.checkSession({},(error,result)=>{\r\n       if(error){\r\n         console.log(`error: ${error.error} - ${error.errorDescription}`);\r\n       }else{\r\n         this.setSession(result);\r\n       }\r\n       if(cb) cb(error,result);\r\n     })\r\n\r\n   }\r\n   scheduleTokenRenewal(){\r\n     const delay=_expire_at-new Date().getTime();\r\n     if(delay>0){\r\n       setTimeout(()=>{\r\n         this.renewToken()\r\n       },delay);\r\n     }\r\n   }\r\n\r\n}"]},"metadata":{},"sourceType":"module"}